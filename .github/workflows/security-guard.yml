name: Security Guard

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UnitOneFlow
        run: |
          pip install unitoneflow anthropic requests

      - name: Generate Manifest
        run: |
          unitoneflow scan . \
            --manifest-file manifest.json \
            --no-interactive

      - name: Detect Vulnerabilities
        id: detect
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          unitoneflow fix \
            --manifest .unitoneflow_generated/manifest.json \
            --repo . \
            --detect-only \
            --output security-report.json

          # Check if vulnerabilities were found
          if [ -f security-report.json ]; then
            VULN_COUNT=$(cat security-report.json | jq '.summary.total_vulnerabilities')
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "found=true" >> $GITHUB_OUTPUT
            else
              echo "found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Fixes
        if: steps.detect.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          unitoneflow fix \
            --manifest .unitoneflow_generated/manifest.json \
            --repo . \
            --apply \
            --output security-fixes.json

      - name: Create Fix Branch and PR
        if: steps.detect.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Get vulnerability info for branch name
          VULN_TYPE=$(cat security-report.json | jq -r '.vulnerabilities[0].vulnerability_type' | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          BRANCH_NAME="fix/security/$VULN_TYPE-$(date +%s)"

          # Create branch and commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "fix: Security vulnerability fixes

          Automated security fixes generated by UnitOneFlow Security Guard.

          See security-report.json for details."
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "[Security] Fix ${{ steps.detect.outputs.vulnerabilities }} vulnerability(s)" \
            --body "$(cat <<EOF
          ## Security Vulnerability Fixes

          This PR contains automated fixes for security vulnerabilities detected by UnitOneFlow.

          ### Summary
          - **Vulnerabilities Found**: ${{ steps.detect.outputs.vulnerabilities }}
          - **Fixes Applied**: See commit diff

          ### Details
          See security-report.json artifact for full vulnerability details.

          ---
          *Generated by [UnitOneFlow Security Guard](https://github.com/UnitOneAI/unitoneflow)*
          EOF
          )"

      - name: Create Jira Ticket
        if: steps.detect.outputs.found == 'true' && env.JIRA_URL != ''
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT || 'SEC' }}
        run: |
          # Read vulnerability details
          VULN_TYPE=$(cat security-report.json | jq -r '.vulnerabilities[0].vulnerability_type')
          VULN_FILE=$(cat security-report.json | jq -r '.vulnerabilities[0].file_path')
          VULN_DESC=$(cat security-report.json | jq -r '.vulnerabilities[0].description')
          VULN_SEVERITY=$(cat security-report.json | jq -r '.vulnerabilities[0].severity')
          TOTAL_VULNS=$(cat security-report.json | jq '.summary.total_vulnerabilities')

          # Map severity to Jira priority
          case "$VULN_SEVERITY" in
            critical) PRIORITY="Highest" ;;
            high) PRIORITY="High" ;;
            medium) PRIORITY="Medium" ;;
            *) PRIORITY="Low" ;;
          esac

          # Create Jira ticket
          curl -s -X POST "$JIRA_URL/rest/api/3/issue" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(cat <<EOF
          {
            "fields": {
              "project": {"key": "$JIRA_PROJECT"},
              "summary": "[Security] $VULN_TYPE in $VULN_FILE",
              "description": {
                "type": "doc",
                "version": 1,
                "content": [{
                  "type": "paragraph",
                  "content": [{
                    "type": "text",
                    "text": "Security vulnerability detected by UnitOneFlow.\n\nType: $VULN_TYPE\nFile: $VULN_FILE\nSeverity: $VULN_SEVERITY\nTotal vulnerabilities: $TOTAL_VULNS\n\nDescription: $VULN_DESC"
                  }]
                }]
              },
              "issuetype": {"name": "Bug"},
              "priority": {"name": "$PRIORITY"},
              "labels": ["security", "automated", "unitoneflow"]
            }
          }
          EOF
          )"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            .unitoneflow_generated/manifest.json
            security-report.json
            security-fixes.json
